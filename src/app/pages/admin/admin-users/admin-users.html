<!-- src/app/pages/admin-users/admin-users.html -->
<app-toast [message]="toastMessage"></app-toast>

<div class="p-6 bg-slate-50 min-h-screen">
    <h2 class="text-2xl font-bold mb-6 text-sky-700 flex items-center gap-2">
        üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng
    </h2>

    <div class="mb-4">
        <button (click)="onAddUser()"
            class="px-4 py-2 text-sm font-semibold rounded bg-sky-600 text-white hover:bg-sky-700 transition cursor-pointer">
            ‚ûï Th√™m ng∆∞·ªùi d√πng
        </button>
    </div>

    <div *ngIf="error" class="text-red-600 font-semibold mb-4">
        ‚ùå {{ error }}
    </div>

    <div class="overflow-x-auto rounded-xl shadow-lg border border-slate-200 bg-white transition-opacity duration-300"
        [class.opacity-50]="isLoading">
        <table class="min-w-full text-sm text-left text-gray-700">
            <thead class="bg-sky-100 text-sky-800">
                <tr>
                    <th class="px-4 py-3 font-semibold text-center">STT</th>
                    <th class="px-4 py-3 font-semibold">T√†i kho·∫£n</th>
                    <th class="px-4 py-3 font-semibold">Email</th>
                    <th class="px-4 py-3 font-semibold">Vai tr√≤</th>
                    <th class="px-4 py-3 font-semibold text-center">Tr·∫°ng th√°i</th>
                    <th class="px-4 py-3 font-semibold text-center">T√°c v·ª•</th>
                </tr>
            </thead>

            <tbody>
                <tr *ngIf="isLoading">
                    <td colspan="6" class="py-6 text-center">
                        <div class="flex justify-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-4 border-sky-500 border-t-transparent">
                            </div>
                        </div>
                    </td>
                </tr>

                <ng-container *ngIf="!isLoading">
                    <tr *ngFor="let u of paginatedUsers; let i = index" class="border-t hover:bg-slate-50 transition">
                        <td class="px-4 py-2 text-center">{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                        <td class="px-4 py-2">{{ u.username }}</td>
                        <td class="px-4 py-2">{{ u.email || '‚Äî' }}</td>
                        <td class="px-4 py-2">{{ u.roleId === 1 ? 'Admin' : 'User' }}</td>
                        <td class="px-4 py-2 text-center">
                            <span *ngIf="u.isActive"
                                class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">
                                ƒêang ho·∫°t ƒë·ªông
                            </span>
                            <span *ngIf="!u.isActive"
                                class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">
                                Ng∆∞ng ho·∫°t ƒë·ªông
                            </span>
                        </td>
                        <td class="px-4 py-2 text-center space-x-2">
                            <button (click)="viewUser(u)"
                                class="px-3 py-1 text-xs rounded bg-green-100 text-green-700 hover:bg-green-200 transition cursor-pointer">
                                üëÅÔ∏è Xem
                            </button>
                            <button (click)="editUser(u)"
                                class="px-3 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition cursor-pointer">
                                ‚úèÔ∏è S·ª≠a
                            </button>
                            <button (click)="openDeleteConfirm(u)"
                                class="px-3 py-1 text-xs rounded bg-red-100 text-red-700 hover:bg-red-200 transition cursor-pointer">
                                üóëÔ∏è X√≥a
                            </button>
                        </td>
                    </tr>

                    <tr *ngIf="!paginatedUsers.length && !isLoading">
                        <td colspan="6" class="py-6 text-center text-gray-500">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o</td>
                    </tr>
                </ng-container>
            </tbody>
        </table>
    </div>

    <div class="mt-8 flex justify-center items-center gap-3 flex-wrap">
        <button (click)="currentPage > 1 && changePage(currentPage - 1)" [class.opacity-50]="currentPage === 1"
            class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-100 transition cursor-pointer">
            &lt;
        </button>

        <button *ngFor="let page of getSimplePages()" (click)="changePage(page)"
            [class.bg-sky-500]="page === currentPage" [class.text-white]="page === currentPage"
            [class.bg-white]="page !== currentPage" [class.text-gray-700]="page !== currentPage"
            class="w-10 h-10 rounded-lg font-medium hover:bg-sky-100 transition border border-gray-300 cursor-pointer">
            {{ page }}
        </button>

        <button (click)="currentPage < totalPages && changePage(currentPage + 1)"
            [class.opacity-50]="currentPage === totalPages"
            class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-100 transition cursor-pointer">
            &gt;
        </button>
    </div>
</div>

<!-- Sidebar th√™m/ch·ªânh s·ª≠a ng∆∞·ªùi d√πng -->
<div *ngIf="showModal" class="fixed inset-0 z-50 flex justify-end pointer-events-none">
    <div
        class="relative bg-white w-full max-w-md h-full shadow-2xl border-l border-slate-200 animate__animated animate__slideInRight animate__faster z-10 flex flex-col pointer-events-auto">
        <div class="p-6 flex-1 overflow-y-auto">
            <h3 class="text-xl font-bold text-sky-700 mb-5 flex items-center gap-2">
                {{ modalMode === 'add' ? '‚ûï Th√™m ng∆∞·ªùi d√πng m·ªõi' : modalMode === 'edit' ? '‚úèÔ∏è Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng' :
                'üëÅÔ∏è Chi ti·∫øt ng∆∞·ªùi d√πng' }}
            </h3>

            <div *ngIf="modalMode === 'view'" class="space-y-4">
                <p><strong>T√†i kho·∫£n:</strong> {{ modalUser.username }}</p>
                <p><strong>Email:</strong> {{ modalUser.email || '‚Äî' }}</p>
                <p><strong>Vai tr√≤:</strong> {{ modalUser.roleId === 1 ? 'Admin' : 'User' }}</p>
                <p><strong>Tr·∫°ng th√°i:</strong> {{ modalUser.isActive ? 'ƒêang ho·∫°t ƒë·ªông' : 'Ng∆∞ng ho·∫°t ƒë·ªông' }}</p>
            </div>

            <div *ngIf="modalMode !== 'view'" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">T√†i kho·∫£n <span
                            class="text-red-500">*</span></label>
                    <input [(ngModel)]="modalUser.username"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition"
                        placeholder="Nh·∫≠p t√™n t√†i kho·∫£n" />
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                    <input [(ngModel)]="modalUser.email" type="email"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition"
                        placeholder="example@domain.com" />
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Vai tr√≤</label>
                    <select [(ngModel)]="modalUser.roleId"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        <option [ngValue]="1">Admin</option>
                        <option [ngValue]="2">User</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tr·∫°ng th√°i</label>
                    <select [(ngModel)]="modalUser.isActive"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        <option [ngValue]="true">ƒêang ho·∫°t ƒë·ªông</option>
                        <option [ngValue]="false">Ng∆∞ng ho·∫°t ƒë·ªông</option>
                    </select>
                </div>

                <div *ngIf="modalMode === 'add'">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">M·∫≠t kh·∫©u <span
                            class="text-red-500">*</span></label>
                    <input type="password" [(ngModel)]="modalUser.password"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
                </div>
            </div>
        </div>

        <div class="p-6 border-t flex justify-end gap-3">
            <button *ngIf="modalMode !== 'view'" (click)="saveUser()"
                class="px-5 py-2.5 rounded-lg bg-sky-600 text-white font-semibold hover:bg-sky-700 transition shadow-md cursor-pointer">
                {{ modalMode === 'add' ? 'Th√™m m·ªõi' : 'L∆∞u thay ƒë·ªïi' }}
            </button>
            <button (click)="closeModal()"
                class="px-5 py-2.5 rounded-lg bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition cursor-pointer">
                ƒê√≥ng
            </button>
        </div>
    </div>
</div>

<!-- Confirm modal (no dark backdrop) -->
<div *ngIf="showConfirmBox" class="fixed inset-0 z-50 flex items-center justify-center bg-transparent"
    (click)="closeConfirmBox()">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm" (click)="$event.stopPropagation()">
        <h3 class="text-lg font-bold text-red-600 mb-4">X√°c nh·∫≠n x√≥a</h3>
        <p class="text-sm text-gray-700 mb-6">
            B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n <strong>{{ confirmDeleteUser?.username }}</strong> kh√¥ng?
        </p>
        <div class="flex justify-end gap-3">
            <button (click)="confirmDelete()"
                class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 font-semibold cursor-pointer">
                X√≥a
            </button>
            <button (click)="closeConfirmBox()"
                class="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold cursor-pointer">
                H·ªßy
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .animate__slideInRight {
        animation: slideInRight 0.35s ease-out forwards;
    }
</style>